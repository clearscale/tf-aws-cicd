# AWS CI/CD with CodeCommit, CodeBuiild, and CodePipeline

This module utilizes `tf-aws-cicd-codebuild` and `tf-aws-cicd-codepipeline` to deliver either a same account or cross-account CI/CD pipeline. Currently, it works well with the external `tf-aws-cicd-codecommit` module for SCM repositories. 

## Prerequisites

1. A VPC, Subnets, and Security group of the pipeline to run in.
2. IAM user or role ARNs of the admins and owner of the KMS key. The KMS key will be generated in the pipeline account.
3. Deploy CodeCommit repo in a shared account or the same account where the pipeline will run using [tf-aws-cicd-codecommit](https://github.com/clearscale/tf-aws-cicd-codecommit).
    - Push code to the repo so that at least the primary `main` branch gets created.
    - Save the `Canonical ID` of the CodeCommit Repository account if it's in a different account than the pipeline.
         - `aws s3api list-buckets --query Owner.ID --output text`
    - Save the `Account ID` of the CodeCommit Repository account if it's in a different account than the pipeline.
        - `aws sts get-caller-identity --query Account --output text`
    - Save the `IAM Role ARN` generated by the deployment of the CodeCommit module.
4. A YAML script in your deployment directory (i.e., `./scripts/plan.yml`). It needs to be a path that this module can access.
5. Deploy this CI/CD module in the account where the pipeline should run.
6. Update CodeCommit Repo `var.trusts[]` with S3 bucket ARN, CodePipeline ARN, and KMS Key ARN outputs from this module.
    - `NOTE:` The first automatic execution (immediately after deployment) will fail because these trusts are not in place.

## Usage

Examples of how to use this module.

### Example build YAML

This script should go inyour deployment directory or a subdirdctory under it. The full path will need to be passed to this module as `var.stages[x].resource.script`.

```yaml
version: 0.2
env:
  shell: bash
phases:
  build:
    commands:
      - echo "test:terraform init"
      - echo "test:terraform plan"
```

#### Cross-Account Terraform

This example creates a CodePipeline that pulls code from a CodeCommit repository in another account located in the same AWS Organization called the `shared` account.

```terraform
#
# Create a CodeCommit repository in the SHARED account using tf-aws-cicd-codecommit prior to deployment.
#
module "codecommit" {
  source    = "https://github.com/clearscale/tf-aws-cicd-codecommit.git?ref=v1.0.0"

  account = {
    id = "*", name = local.account.name, provider = "aws", key = "current", region = local.region.name
  }


  prefix  = local.context.prefix
  client  = local.context.client
  project = local.context.project
  env     = local.account.name
  region  = local.region.name
  name    = "codecommit"

  repo = {
    name   = "test-shared-account"
    create = true
  }

  #
  # To be filled in and redeployed after the first successful deployment. These resources do not exist prior to module.cicd being deployed.
  # trusts = [
  #  "ARN_S3_BUCKET,
  #  "ARN_KMS_KEY", # Must be the key ARN - not an alias.
  #  "ARN_CODEPIPELINE"
  # ]
  #
}

module "cicd" {
  source = "https://github.com/clearscale/tf-aws-cicd.git?ref=v1.0.0"

  account = {
    id = "*", name = local.account.name, provider = "aws", key = "current", region = local.region.name
  }

  prefix  = local.context.prefix
  client  = local.context.client
  project = local.context.project
  env     = local.account.name
  region  = local.region.name
  name    = "cicd"


  # Optional
  iam_service_role_policies = [
    "arn:aws:iam::aws:policy/PowerUserAccess"
  ]

  vpc = {
    id              = "VPC_ID"
    subnets         = ["SUBNET_ID_1", "SUBNET_ID_2"]
    security_groups = ["SG_ID_1", "SG_ID_2"],
  }

  repo = {
    name     = "test-shared-account"
    branch   = "main"
    role_arn = "arn:aws:iam::123456789012:role/CsTffwkcs.Shared.USW1.CodeCommit.TestSharedAccount"
    account = {
      name         = "shared"
      id           = "123456789012"                                                            # Account ID of the CodeCommit account.
      id_canonical = "2B3C4D5E6F7A8B9C0D1E2F3A4B5C6D7E8F9A0B1C2D3E4F5A6B7C8D9E0F1A2B3C4D5E6F7" # Canonical ID of the CodeCommit account.
    }
  }

  stages = [{
    name = "Plan"
    action = { # https://docs.aws.amazon.com/codepipeline/latest/userguide/action-reference.html
      provider      = "CodeBuild"
      configuration = {
        ProjectName = "plan" # IAM Roles will be generated based on this name, so they need too be unique across pipelines.
      }
    }
    resource = {
      description = "MyPrefix: Plan project resources."
      script      = "${abspath(path.module)}/scripts/plan.yml"
      compute = {
        compute_type = "BUILD_GENERAL1_SMALL"
        image        = "aws/codebuild/standard:6.0-22.06.30" # "ACCOUNTID.dkr.ecr.REGION.amazonaws.com/ecr-repo:latest"
        type         = "LINUX_CONTAINER"
      }
    }
  }, {
    name   = "Apply"
    action = { # https://docs.aws.amazon.com/codepipeline/latest/userguide/action-reference.html
      provider      = "CodeBuild"
      configuration = {
        ProjectName = "apply" # IAM Roles will be generated based on this name, so they need too be unique across pipelines.
      }
    }
    resource = {
      description = "MyPrefix: Apply project resources."
      script      = "${abspath(path.module)}/scripts/plan.yml"
      compute = {
        compute_type = "BUILD_GENERAL1_SMALL"
        image        = "aws/codebuild/standard:6.0-22.06.30" # "ACCOUNTID.dkr.ecr.REGION.amazonaws.com/ecr-repo:latest"
        type         = "LINUX_CONTAINER"
      }
    }
  }]
}
```

#### Same-Account Terraform

This example creates a CodePipeline resource that pulls from a CodeCommit repository residing in the same account.

```terraform
module "codecommit" {
  source    = "https://github.com/clearscale/tf-aws-cicd-codecommit.git?ref=v1.0.0"

  account = {
    id = "*", name = local.account.name, provider = "aws", key = "current", region = local.region.name
  }


  prefix  = local.context.prefix
  client  = local.context.client
  project = local.context.project
  env     = local.account.name
  region  = local.region.name
  name    = "codecommit"

  repo = {
    name   = "test-same-account"
    create = true
  }

  #
  # To be filled in and redeployed after the first successful deployment. These resources do not exist prior to module.cicd being deployed.
  # trusts = [
  #  "ARN_S3_BUCKET,
  #  "ARN_KMS_KEY", # Must be the key ARN - not an alias.
  #  "ARN_CODEPIPELINE"
  # ]
  #
}

module "cicd" {
  source = "https://github.com/clearscale/tf-aws-cicd.git?ref=v1.0.0"

  account = {
    id = "*", name = local.account.name, provider = "aws", key = "current", region = local.region.name
  }

  prefix  = local.context.prefix
  client  = local.context.client
  project = local.context.project
  env     = local.account.name
  region  = local.region.name
  name    = "cicd"


  # User account ARNs who can own and use the KMS key
  kms = {
    owners = [
      "arn:aws:iam::${module.import.vars.account.id}:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_AWSAdministratorAccess_1234567890123456"
    ]
    admins = [
      "arn:aws:iam::${module.import.vars.account.id}:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_AWSAdministratorAccess_1234567890123456"
    ]
    users = [
      "arn:aws:iam::${module.import.vars.account.id}:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_AWSAdministratorAccess_1234567890123456"
    ]
  }


  iam_service_role_policies = [
    "arn:aws:iam::aws:policy/PowerUserAccess"
  ]

  vpc = {
    id              = "VPC_ID"
    subnets         = ["SUBNET_ID_1", "SUBNET_ID_2"]
    security_groups = ["SG_ID_1", "SG_ID_2"],
  }

  repo = {
    name     = "test-same-account"
    branch   = "main"
    role_arn = module.codecommit.role.arn
  }

  stages = [{
    name = "Plan"
    action = {
      provider      = "CodeBuild"
      configuration = {
        ProjectName = "plan" # IAM Roles will be generated based on this name, so they need too be unique across pipelines.
      }
    }
    resource = {
      description = "MyPrefix: Plan project resources."
      script      = "${abspath(path.module)}/scripts/plan.yml"
      compute = {
        compute_type = "BUILD_GENERAL1_SMALL"
        image        = "aws/codebuild/standard:6.0-22.06.30" # "ACCOUNTID.dkr.ecr.REGION.amazonaws.com/ecr-repo:latest"
        type         = "LINUX_CONTAINER"
      }
    }
  }, {
    name   = "Apply"
    action = {
      provider      = "CodeBuild"
      configuration = {
        ProjectName = "apply" # IAM Roles will be generated based on this name, so they need too be unique across pipelines.
      }
    }
    resource = {
      description = "MyPrefix: Apply project resources."
      script      = "${abspath(path.module)}/scripts/plan.yml"
      compute = {
        compute_type = "BUILD_GENERAL1_SMALL"
        image        = "aws/codebuild/standard:6.0-22.06.30" # "ACCOUNTID.dkr.ecr.REGION.amazonaws.com/ecr-repo:latest"
        type         = "LINUX_CONTAINER"
      }
    }
  }]
}
```

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.6.1 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | ~> 5.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | ~> 5.0 |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_aws_cicd_codebuild"></a> [aws\_cicd\_codebuild](#module\_aws\_cicd\_codebuild) | ../tf-aws-cicd-codebuild | n/a |
| <a name="module_aws_cicd_codepipeline"></a> [aws\_cicd\_codepipeline](#module\_aws\_cicd\_codepipeline) | ../tf-aws-cicd-codepipeline | n/a |
| <a name="module_aws_cicd_codepipeline_iam"></a> [aws\_cicd\_codepipeline\_iam](#module\_aws\_cicd\_codepipeline\_iam) | ../tf-aws-cicd-codepipeline/iam | n/a |
| <a name="module_kms"></a> [kms](#module\_kms) | terraform-aws-modules/kms/aws | 2.0.1 |
| <a name="module_s3_bucket"></a> [s3\_bucket](#module\_s3\_bucket) | terraform-aws-modules/s3-bucket/aws | 3.15.1 |
| <a name="module_std"></a> [std](#module\_std) | github.com/clearscale/tf-standards.git | v1.0.0 |
| <a name="module_std_codepipeline"></a> [std\_codepipeline](#module\_std\_codepipeline) | github.com/clearscale/tf-standards.git | v1.0.0 |

## Resources

| Name | Type |
|------|------|
| [aws_caller_identity.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/caller_identity) | data source |
| [aws_canonical_user_id.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/canonical_user_id) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_account"></a> [account](#input\_account) | (Required). Cloud provider account object. | <pre>object({<br>    key      = optional(string, "current")<br>    provider = optional(string, "aws")<br>    id       = optional(string, "*") <br>    name     = string<br>    region   = optional(string, null)<br>  })</pre> | <pre>{<br>  "id": "*",<br>  "name": "shared"<br>}</pre> | no |
| <a name="input_client"></a> [client](#input\_client) | (Optional). Name of the client | `string` | `"ClearScale"` | no |
| <a name="input_env"></a> [env](#input\_env) | (Optional). Name of the current environment. | `string` | `"dev"` | no |
| <a name="input_iam_service_role_policies"></a> [iam\_service\_role\_policies](#input\_iam\_service\_role\_policies) | (Optional). List of IAM policy ARNs to attach to the primary service roles. | `list(string)` | `[]` | no |
| <a name="input_kms"></a> [kms](#input\_kms) | (Optional). KMS key settings. | <pre>object({<br>    owners = optional(list(string), [])<br>    admins = optional(list(string), [])<br>    users  = optional(list(string), [])<br>  })</pre> | `{}` | no |
| <a name="input_name"></a> [name](#input\_name) | (Optional). The name of the pipeline. | `string` | `"default"` | no |
| <a name="input_prefix"></a> [prefix](#input\_prefix) | (Optional). Prefix override for all generated naming conventions. | `string` | `null` | no |
| <a name="input_project"></a> [project](#input\_project) | (Optional). Name of the client project. | `string` | `"int"` | no |
| <a name="input_region"></a> [region](#input\_region) | (Optional). Name of the region. | `string` | `"us-west-1"` | no |
| <a name="input_repo"></a> [repo](#input\_repo) | (Required). Repository URL and branch name. | <pre>object({<br>    name     = string<br>    branch   = string<br>    role_arn = string<br>    kms_key = optional(string, null)<br>    account = optional(object({<br>      id           = optional(number, null)<br>      id_canonical = optional(string, null)<br>      name         = optional(string, null)<br>    }), null)<br>  })</pre> | n/a | yes |
| <a name="input_secrets"></a> [secrets](#input\_secrets) | (Optional). List of secret names that are stored in Secrets Manager which CodeBuild should be able to read. | `list(string)` | `[]` | no |
| <a name="input_stages"></a> [stages](#input\_stages) | (Required). List of stages for CodePipeline. configuration.ProjectName is required. | <pre>list(object({<br>    name   = string<br>    action = object({<br>      name            = optional(string, "Build")<br>      category        = optional(string, "Build")<br>      provider        = optional(string, "CodeBuild")<br>      version         = optional(string, "1")<br>      owner           = optional(string, "AWS")<br>      region          = optional(string, null)<br>      input_artifacts = optional(list(string), null)<br>      configuration   = optional(object({<br>        ProjectName = string<br>      }), null)<br>    })<br>    resource = object({<br>      region                    = optional(string, null)<br>      name                      = optional(string, null)<br>      description               = optional(string, null)<br>      script                    = optional(string, null)<br>      iam_service_role_policies = optional(list(string), [])<br><br>      # https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/codebuild_project#environment<br>      # https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-available.html<br>      compute = optional(object({<br>        compute_type = optional(string, "BUILD_GENERAL1_SMALL")<br>        image        = optional(string, "aws/codebuild/amazonlinux2-x86_64-standard:5.0")<br>        type         = optional(string, "LINUX_CONTAINER")<br>      }))<br><br>      # Inherits var.vpc if not set.<br>      vpc = optional(object({<br>        id              = optional(string,       null) # vpc id<br>        subnets         = optional(list(string), null) # ids<br>        security_groups = optional(list(string), null) # ids<br>      }), null)<br>    })<br>    secrets = optional(list(string), [])<br>    logs    = optional(list(string), [])<br>  }))</pre> | n/a | yes |
| <a name="input_vpc"></a> [vpc](#input\_vpc) | (Required). Global VPC configuration for the CodeBuild projects where they are not specifically defined. | <pre>object({<br>    id              = string       # vpc id<br>    subnets         = list(string) # ids<br>    security_groups = list(string) # ids<br>  })</pre> | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_cache"></a> [cache](#output\_cache) | Location path for the cached resources. |
| <a name="output_codebuild"></a> [codebuild](#output\_codebuild) | All CodeBuild outputs. |
| <a name="output_codepipeline"></a> [codepipeline](#output\_codepipeline) | All CodePipeline outputs. |
| <a name="output_kms"></a> [kms](#output\_kms) | KMS related data. |
| <a name="output_name"></a> [name](#output\_name) | The name of the CICD resources. |
| <a name="output_s3"></a> [s3](#output\_s3) | KMS related data |
<!-- END_TF_DOCS -->